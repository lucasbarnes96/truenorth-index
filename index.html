<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>True Inflation Canada</title>
  <meta name="description" content="Finance-first Canadian inflation nowcast with transparent source diagnostics." />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* =========================================================
       DESIGN TOKENS ‚Äî Apple-inspired
    ========================================================= */
    :root {
      --bg: #f5f5f7;
      --surface: #ffffff;
      --surface-2: #f5f5f7;
      --surface-elevated: rgba(255, 255, 255, 0.85);
      --border: rgba(0, 0, 0, 0.08);
      --border-strong: rgba(0, 0, 0, 0.14);

      --text: #1d1d1f;
      --text-secondary: #6e6e73;
      --text-tertiary: #98989d;

      --blue: #0071e3;
      --blue-light: #e8f1fb;
      --green: #28cd41;
      --green-light: #e3f8e7;
      --amber: #ff9f0a;
      --amber-light: #fff4e0;
      --red: #ff3b30;
      --red-light: #ffe5e4;

      --accent: var(--blue);

      --radius-sm: 8px;
      --radius-md: 14px;
      --radius-lg: 20px;
      --radius-xl: 28px;

      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 2px 12px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.10), 0 2px 8px rgba(0, 0, 0, 0.06);

      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      --font-mono: ui-monospace, "SF Mono", "Cascadia Code", "Fira Code", monospace;
    }

    /* =========================================================
       RESET & BASE
    ========================================================= */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      -webkit-text-size-adjust: 100%;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* =========================================================
       STICKY NAV
    ========================================================= */
    .nav {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(245, 245, 247, 0.72);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--border);
      padding: 0 max(1.25rem, env(safe-area-inset-right));
      padding-left: max(1.25rem, env(safe-area-inset-left));
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .nav-logo {
      width: 30px;
      height: 30px;
      background: linear-gradient(135deg, #0071e3 0%, #42a5f5 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      flex-shrink: 0;
    }

    .nav-title {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      color: var(--text);
    }

    .nav-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-date {
      font-size: 0.78rem;
      color: var(--text-secondary);
      font-family: var(--font-mono);
    }

    /* =========================================================
       PAGE LAYOUT
    ========================================================= */
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem max(1.25rem, env(safe-area-inset-right)) 3rem;
      padding-left: max(1.25rem, env(safe-area-inset-left));
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* =========================================================
       CARDS
    ========================================================= */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 1.5rem;
    }

    .card-sm {
      padding: 1.1rem 1.25rem;
    }

    /* =========================================================
       SECTION LABELS
    ========================================================= */
    .section-label {
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    /* =========================================================
       PILLS / BADGES
    ========================================================= */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .pill-green {
      background: var(--green-light);
      color: #1a7f2e;
    }

    .pill-amber {
      background: var(--amber-light);
      color: #a85e00;
    }

    .pill-red {
      background: var(--red-light);
      color: #c0392b;
    }

    .pill-blue {
      background: var(--blue-light);
      color: #004bab;
    }

    /* =========================================================
       RELEASE BANNER
    ========================================================= */
    .release-banner {
      display: none;
      border-radius: var(--radius-md);
      background: var(--amber-light);
      border: 1px solid rgba(255, 159, 10, 0.3);
      padding: 0.75rem 1.1rem;
      font-size: 0.85rem;
      color: #7a4700;
    }

    /* =========================================================
       HERO SECTION
    ========================================================= */
    .hero-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
      align-items: start;
    }

    .hero-eyebrow {
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 0.4rem;
    }

    .hero-number {
      font-size: clamp(4rem, 12vw, 7rem);
      font-weight: 700;
      letter-spacing: -0.04em;
      line-height: 1;
      margin-bottom: 0.6rem;
    }

    .hero-number.tone-good {
      color: #28cd41;
    }

    .hero-number.tone-warn {
      color: #ff9f0a;
    }

    .hero-number.tone-bad {
      color: #ff3b30;
    }

    .hero-number.tone-neutral {
      color: var(--text);
    }

    .hero-caption {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.5;
      max-width: 38ch;
    }

    .hero-stats {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      min-width: 180px;
    }

    @media (max-width: 640px) {
      .hero-grid {
        grid-template-columns: 1fr;
      }

      .hero-stats {
        flex-direction: row;
        flex-wrap: wrap;
        min-width: 0;
      }
    }

    .stat-chip {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 0.85rem 1rem;
      flex: 1;
      min-width: 130px;
    }

    .stat-chip .eyebrow {
      font-size: 0.68rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 0.3rem;
    }

    .stat-chip .value {
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
      font-family: var(--font-mono);
    }

    .stat-chip .note {
      font-size: 0.72rem;
      color: var(--text-tertiary);
      margin-top: 0.2rem;
      font-family: var(--font-mono);
    }

    /* =========================================================
       PULSE ‚Äî LEADING INDICATORS
    ========================================================= */
    .pulse-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 480px) {
      .pulse-row {
        grid-template-columns: 1fr;
      }
    }

    .pulse-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1.1rem 1.25rem;
      box-shadow: var(--shadow-sm);
      border-left: 3px solid var(--blue);
      position: relative;
    }

    .pulse-card.gas {
      border-left-color: var(--amber);
    }

    .pulse-eyebrow {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .live-dot {
      width: 6px;
      height: 6px;
      background: var(--green);
      border-radius: 50%;
      animation: blink 2s ease-in-out infinite;
      flex-shrink: 0;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 0.5;
        transform: scale(0.9);
      }

      50% {
        opacity: 1;
        transform: scale(1.1);
      }
    }

    .pulse-value {
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      color: var(--text);
      font-family: var(--font-mono);
    }

    .pulse-source {
      font-size: 0.72rem;
      color: var(--text-tertiary);
      margin-top: 0.2rem;
      font-family: var(--font-mono);
    }

    /* =========================================================
       RELEASE INTELLIGENCE GRID
    ========================================================= */
    .chip-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    @media (max-width: 768px) {
      .chip-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .chip-grid {
        grid-template-columns: 1fr;
      }
    }

    .intel-chip {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 1rem 1.1rem;
      transition: box-shadow 0.15s ease;
    }

    .intel-chip:hover {
      box-shadow: var(--shadow-md);
    }

    .intel-chip .eyebrow {
      font-size: 0.67rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 0.4rem;
    }

    .intel-chip .chip-value {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--text);
      font-family: var(--font-mono);
      letter-spacing: -0.01em;
      margin-bottom: 0.25rem;
      word-break: break-word;
    }

    .intel-chip .chip-note {
      font-size: 0.7rem;
      color: var(--text-tertiary);
      font-family: var(--font-mono);
    }

    /* =========================================================
       CHARTS
    ========================================================= */
    .chart-container {
      position: relative;
      width: 100%;
      height: 280px;
    }

    @media (max-width: 480px) {
      .chart-container {
        height: 220px;
      }
    }

    /* =========================================================
       TWO COLUMN EXPERT GRID
    ========================================================= */
    .expert-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .expert-grid {
        grid-template-columns: 1fr;
      }
    }

    /* =========================================================
       TABLE ‚Äî Data Source Diagnostics
    ========================================================= */
    .table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: var(--radius-md);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      min-width: 560px;
    }

    thead th {
      text-align: left;
      padding: 0.6rem 0.75rem;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-strong);
      background: var(--surface-2);
    }

    thead th:first-child {
      border-radius: var(--radius-sm) 0 0 0;
    }

    thead th:last-child {
      border-radius: 0 var(--radius-sm) 0 0;
    }

    tbody td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
      color: var(--text);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:nth-child(even) td {
      background: #fafafa;
    }

    .status-ok {
      color: #1a7f2e;
      font-weight: 600;
    }

    .status-warn {
      color: #a85e00;
      font-weight: 600;
    }

    .status-err {
      color: #c0392b;
      font-weight: 600;
    }

    /* =========================================================
       ACCORDION / DETAILS
    ========================================================= */
    .accordion {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--surface);
      overflow: hidden;
    }

    .accordion summary {
      list-style: none;
      cursor: pointer;
      padding: 1rem 1.25rem;
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      -webkit-user-select: none;
    }

    .accordion summary::-webkit-details-marker {
      display: none;
    }

    .accordion summary::after {
      content: "+";
      font-size: 1.2rem;
      font-weight: 300;
      color: var(--text-secondary);
      transition: transform 0.2s ease;
    }

    .accordion[open] summary::after {
      content: "‚àí";
    }

    .accordion-body {
      padding: 0 1.25rem 1.25rem;
      border-top: 1px solid var(--border);
    }

    .meta-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding-top: 0.75rem;
    }

    .meta-list li {
      font-size: 0.86rem;
      color: var(--text-secondary);
      padding-left: 1rem;
      position: relative;
      line-height: 1.5;
    }

    .meta-list li::before {
      content: "¬∑";
      position: absolute;
      left: 0;
      color: var(--text-tertiary);
    }

    /* =========================================================
       HOW TO READ ‚Äî explainer
    ========================================================= */
    .explainer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    @media (max-width: 560px) {
      .explainer-grid {
        grid-template-columns: 1fr;
      }
    }

    .explainer-item {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 0.9rem 1rem;
      font-size: 0.84rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* =========================================================
       PURCHASING POWER CARD
    ========================================================= */
    .power-card {
      background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fd 100%);
      border: 1px solid rgba(0, 113, 227, 0.15);
    }

    .power-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--text);
      margin: 0.4rem 0 0.5rem;
    }

    .power-body {
      font-size: 0.88rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* =========================================================
       COMMUNITY SECTION
    ========================================================= */
    #community-section {
      display: none;
    }

    .community-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.75rem;
    }

    /* =========================================================
       FOOTER
    ========================================================= */
    .footer {
      text-align: center;
      font-size: 0.78rem;
      color: var(--text-tertiary);
      padding: 1rem 0 calc(1rem + env(safe-area-inset-bottom));
      line-height: 1.6;
    }

    .footer a {
      color: var(--blue);
      text-decoration: none;
    }

    /* =========================================================
       UTILITY
    ========================================================= */
    .tone-good {
      color: #28cd41;
    }

    .tone-warn {
      color: #ff9f0a;
    }

    .tone-bad {
      color: #ff3b30;
    }

    .loading {
      color: var(--text-tertiary);
      font-size: 0.9rem;
    }

    .panel-title {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--text);
      margin-bottom: 1rem;
    }

    .chart-placeholder {
      font-size: 0.88rem;
      color: var(--text-secondary);
      padding: 1.5rem 0;
      text-align: center;
    }

    .small-note {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      font-family: var(--font-mono);
    }
  </style>
</head>

<body>

  <!-- NAV -->
  <nav class="nav">
    <div class="nav-brand">
      <div class="nav-logo">üçÅ</div>
      <span class="nav-title">True Inflation Canada</span>
    </div>
    <div class="nav-meta">
      <span class="nav-date" id="asof">‚Äî</span>
      <span class="pill pill-blue" style="font-size:0.7rem; padding:0.2rem 0.6rem;">NOWCAST</span>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="page" id="app">

    <!-- RELEASE BANNER -->
    <div id="release-banner" class="release-banner"></div>

    <!-- HERO -->
    <section class="card">
      <div class="hero-grid">
        <div>
          <div class="hero-eyebrow">Official CPI ‚Äî Year over Year</div>
          <div id="hero-yoy" class="hero-number tone-neutral">‚Äî</div>
          <div id="hero-summary" class="hero-caption loading">Loading inflation data‚Ä¶</div>
        </div>
        <div class="hero-stats">
          <div class="stat-chip">
            <div class="eyebrow">Nowcast Signal</div>
            <div class="value" id="hero-nowcast">‚Äî</div>
            <div class="note" id="hero-divergence">YoY deviation: ‚Äî</div>
          </div>
          <div class="stat-chip">
            <div class="eyebrow">Release Month</div>
            <div class="value" id="hero-release">‚Äî</div>
            <div class="note" id="hero-confidence">Confidence: ‚Äî | Quality: ‚Äî</div>
          </div>
        </div>
      </div>
    </section>

    <!-- LEADING INDICATORS (Pulse) -->
    <section id="pulse-section" style="display:none;">
      <div class="pulse-row">
        <div class="pulse-card">
          <div class="pulse-eyebrow">
            <span class="live-dot"></span> Avg Asking Rent ¬∑ Canada
          </div>
          <div class="pulse-value" id="pulse-rent">‚Äî</div>
          <div class="pulse-source">Rentals.ca ¬∑ Leading Indicator</div>
        </div>
        <div class="pulse-card gas">
          <div class="pulse-eyebrow">
            <span class="live-dot" style="background:var(--amber);"></span> Avg Regular Gas ¬∑ Canada
          </div>
          <div class="pulse-value" id="pulse-gas">‚Äî</div>
          <div class="pulse-source">NRCAN Weekly ¬∑ Leading Indicator</div>
        </div>
      </div>
    </section>

    <!-- PURCHASING POWER -->
    <section class="card power-card card-sm">
      <div class="section-label">Purchasing Power</div>
      <div class="power-title" id="card-power-title">‚Äî</div>
      <div class="power-body" id="card-power-body">‚Äî</div>
    </section>

    <!-- RELEASE INTELLIGENCE -->
    <section class="card">
      <div class="panel-title">Release Intelligence</div>
      <div class="chip-grid" id="release-grid"></div>
    </section>

    <!-- NOWCAST CHART -->
    <section class="card">
      <div class="panel-title">Nowcast vs Official CPI (Year-over-Year)</div>
      <div class="chart-container">
        <canvas id="divergenceChart"></canvas>
      </div>
    </section>

    <!-- CATEGORY + METHODOLOGY -->
    <div class="expert-grid">
      <section class="card">
        <div class="panel-title">Category Contribution Ranking</div>
        <p id="category-placeholder" class="chart-placeholder" style="display:none;"></p>
        <div class="chart-container" style="height:260px;">
          <canvas id="categoryChart"></canvas>
        </div>
      </section>
      <section class="card">
        <div class="panel-title">Methodology</div>
        <ul id="methodology-list" class="meta-list"></ul>
      </section>
    </div>

    <!-- COMMUNITY -->
    <section id="community-section" class="card">
      <div class="panel-title">Community Reports</div>
      <div class="community-grid" id="community-stats-grid"></div>
    </section>

    <!-- HOW TO READ -->
    <section class="card card-sm">
      <div class="panel-title">How To Read This Dashboard</div>
      <div class="explainer-grid" id="explain-grid"></div>
    </section>

    <!-- PERFORMANCE & CALIBRATION -->
    <details class="accordion card-sm">
      <summary>Signal Performance</summary>
      <div class="accordion-body">
        <ul id="performance-list" class="meta-list"></ul>
      </div>
    </details>

    <details class="accordion card-sm">
      <summary>Calibration &amp; Maturity</summary>
      <div class="accordion-body">
        <ul id="calibration-list" class="meta-list"></ul>
      </div>
    </details>

    <!-- DATA SOURCE DIAGNOSTICS -->
    <section class="card" style="padding: 1.5rem 1.5rem 1rem;">
      <div class="panel-title">Data Source Diagnostics</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Source</th>
              <th>Category</th>
              <th>Status</th>
              <th>Last Run</th>
              <th>Period</th>
              <th>Age (hrs)</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="source-health-body"></tbody>
        </table>
      </div>
    </section>

    <!-- METHODOLOGY NOTES -->
    <details class="accordion card-sm">
      <summary>Methodology Notes &amp; Caveats</summary>
      <div class="accordion-body">
        <ul id="notes-list" class="meta-list"></ul>
      </div>
    </details>

    <!-- FOOTER -->
    <footer class="footer">
      Experimental open-source nowcast using public Statistics Canada data.<br />
      Not official StatCan CPI. <a href="https://github.com/lucasbarnes96/true-inflation-canada" target="_blank">View on
        GitHub</a>
    </footer>

  </main>

  <script>
    const UI_MODE_V2 = new URLSearchParams(window.location.search).get("ui_v2") !== "0";
    let divergenceChart = null;
    let categoryChart = null;

    function pct(v, digits = 2) {
      if (v === null || v === undefined || Number.isNaN(v)) return "--";
      return `${Number(v).toFixed(digits)}%`;
    }

    function maybe(v) {
      return v ?? "--";
    }

    function toneClass(yoy) {
      if (yoy === null || yoy === undefined || Number.isNaN(yoy)) return "tone-neutral";
      if (yoy < 2) return "tone-good";
      if (yoy <= 4) return "tone-warn";
      return "tone-bad";
    }

    function fetchJsonWithFallback(primary, fallback) {
      const toJsonOrThrow = (r) => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.text().then((text) => {
          try {
            return JSON.parse(text);
          } catch {
            throw new Error(`Invalid JSON from ${r.url}`);
          }
        });
      };
      return fetch(primary)
        .then(toJsonOrThrow)
        .catch(() =>
          fetch(fallback)
            .then(toJsonOrThrow)
            .catch(() => ({}))
        );
    }

    function fetchLatestSnapshot() {
      return fetch("/v1/nowcast/latest")
        .then((r) => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        })
        .catch(() =>
          fetch("data/published_latest.json")
            .then((r) => {
              if (!r.ok) throw new Error(`HTTP ${r.status}`);
              return r.json();
            })
            .catch(() => fetchJsonWithFallback("data/latest.json", "data/published_latest.json"))
        );
    }

    function safeHistoryItems(historical) {
      if (Array.isArray(historical.items)) return historical.items;
      return Object.keys(historical || {}).sort().map(day => ({ date: day, ...(historical[day] || {}) }));
    }

    function countLiveNowcastDays(items) {
      return items.filter((d) => {
        const seeded = Boolean(d.meta && d.meta.seeded);
        const yoy = d.headline?.nowcast_yoy_pct;
        return !seeded && yoy !== null && yoy !== undefined;
      }).length;
    }

    function renderDivergence(items) {
      const days = items.map(d => d.date);
      const nowcast = items.map(d => d.headline?.nowcast_yoy_pct ?? null);
      const official = items.map(d => d.official_cpi?.yoy_pct ?? null);
      const firstLiveIndex = items.findIndex((d) => {
        const seeded = Boolean(d.meta && d.meta.seeded);
        const yoy = d.headline?.nowcast_yoy_pct;
        return !seeded && yoy !== null && yoy !== undefined;
      });
      const decorPlugin = {
        id: "liveNowcastDecor",
        beforeDatasetsDraw(chart) {
          if (firstLiveIndex <= 0) return;
          const xScale = chart.scales.x;
          const area = chart.chartArea;
          if (!xScale || !area) return;
          const liveX = xScale.getPixelForValue(firstLiveIndex);
          const ctx = chart.ctx;
          ctx.save();
          ctx.fillStyle = "rgba(110,110,115,0.06)";
          ctx.fillRect(area.left, area.top, Math.max(0, liveX - area.left), area.bottom - area.top);
          ctx.fillStyle = "#98989d";
          ctx.font = "11px 'SF Mono', ui-monospace, monospace";
          ctx.fillText("Pre-live (official only)", area.left + 8, area.top + 16);
          ctx.restore();
        },
        afterDatasetsDraw(chart) {
          if (firstLiveIndex < 0) return;
          const xScale = chart.scales.x;
          const yScale = chart.scales.y;
          const area = chart.chartArea;
          if (!xScale || !yScale || !area) return;
          const val = nowcast[firstLiveIndex];
          if (val === null || val === undefined) return;
          const x = xScale.getPixelForValue(firstLiveIndex);
          const y = yScale.getPixelForValue(val);
          const ctx = chart.ctx;
          ctx.save();
          ctx.strokeStyle = "#0071e3";
          ctx.fillStyle = "#0071e3";
          ctx.lineWidth = 1.5;
          ctx.beginPath();
          ctx.moveTo(x + 6, y - 16);
          ctx.lineTo(x + 42, y - 26);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x + 42, y - 26);
          ctx.lineTo(x + 38, y - 22);
          ctx.lineTo(x + 36, y - 28);
          ctx.closePath();
          ctx.fill();
          ctx.font = "11px 'SF Mono', ui-monospace, monospace";
          ctx.fillText("Live nowcast starts", x + 46, y - 28);
          ctx.restore();
        },
      };

      if (divergenceChart) divergenceChart.destroy();
      const canvas = document.getElementById("divergenceChart");
      divergenceChart = new Chart(canvas, {
        data: {
          labels: days,
          datasets: [
            {
              type: "line",
              label: "Nowcast YoY",
              data: nowcast,
              borderColor: "#0071e3",
              backgroundColor: "rgba(0,113,227,0.08)",
              tension: 0.25,
              spanGaps: false,
              yAxisID: "y",
              pointRadius: 0,
              borderWidth: 2,
            },
            {
              type: "line",
              label: "Official CPI YoY",
              data: official,
              borderColor: "#ff9f0a",
              borderDash: [6, 4],
              backgroundColor: "rgba(0,0,0,0)",
              tension: 0.25,
              yAxisID: "y",
              pointRadius: 0,
              borderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: {
              labels: {
                color: "#6e6e73",
                font: { size: 12, family: "-apple-system, sans-serif" },
                boxWidth: 16,
                padding: 16,
              },
            },
          },
          scales: {
            y: {
              position: "left",
              ticks: { color: "#98989d", font: { size: 11 }, callback: v => v + "%" },
              grid: { color: "rgba(0,0,0,0.05)" },
              border: { display: false },
            },
            x: {
              ticks: { color: "#98989d", font: { size: 11 }, maxTicksLimit: 8 },
              grid: { color: "rgba(0,0,0,0.04)" },
              border: { display: false },
            },
          },
        },
        plugins: [decorPlugin],
      });
    }

    function renderCategoryChart(latest) {
      const names = Object.keys(latest.categories || {});
      const sorted = names
        .map(k => {
          const c = latest.categories[k] || {};
          const contribution = c.proxy_level === null || c.daily_change_pct === null ? null : Number(c.weight) * Number(c.daily_change_pct);
          return { key: k, contribution, points: c.points || 0 };
        })
        .sort((a, b) => Math.abs(b.contribution || 0) - Math.abs(a.contribution || 0));

      const placeholder = document.getElementById("category-placeholder");
      const hasSignal = sorted.some(s => s.contribution !== null && Math.abs(Number(s.contribution)) > 0);
      const canvas = document.getElementById("categoryChart");
      if (!hasSignal) {
        if (categoryChart) {
          categoryChart.destroy();
          categoryChart = null;
        }
        placeholder.style.display = "block";
        placeholder.textContent = "Insufficient day-over-day history for category contribution ranking.";
        canvas.style.display = "none";
        return;
      }
      placeholder.style.display = "none";
      canvas.style.display = "block";

      if (categoryChart) categoryChart.destroy();
      categoryChart = new Chart(canvas, {
        type: "bar",
        data: {
          labels: sorted.map(s => `${s.key} (${s.points})`),
          datasets: [{
            label: "Weighted contribution (pp)",
            data: sorted.map(s => (s.contribution === null ? 0 : s.contribution)),
            backgroundColor: sorted.map(s => ((s.contribution || 0) >= 0
              ? "rgba(0,113,227,0.55)"
              : "rgba(255,59,48,0.55)")),
            borderRadius: 6,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: "#6e6e73",
                font: { size: 11, family: "-apple-system, sans-serif" },
              },
            },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${Number(ctx.parsed.y || 0).toFixed(3)} pp`,
              },
            },
          },
          scales: {
            y: {
              ticks: { color: "#98989d", font: { size: 11 } },
              grid: { color: "rgba(0,0,0,0.05)" },
              border: { display: false },
            },
            x: {
              ticks: { color: "#98989d", font: { size: 10 } },
              grid: { display: false },
              border: { display: false },
            },
          },
        },
      });
    }

    function renderSourceTable(sourceHealth) {
      const tbody = document.getElementById("source-health-body");
      tbody.innerHTML = "";
      const sourceName = {
        openfoodfacts_api: "OpenFoodFacts (crowd prices)",
        statcan_food_prices: "StatCan food prices",
        apify_loblaws: "Loblaws (Apify)",
        statcan_gas_csv: "StatCan fuel prices",
        statcan_cpi_csv: "StatCan CPI table",
        oeb_scrape: "Ontario Energy Board",
        statcan_energy_cpi_csv: "StatCan energy CPI",
      };
      const categoryName = {
        food: "Food",
        housing: "Housing / shelter",
        transport: "Transport / fuel",
        energy: "Energy / utilities",
        communication: "Phone / internet",
        health_personal: "Health / personal",
        recreation_education: "Recreation / edu",
      };
      sourceHealth.forEach(row => {
        const tr = document.createElement("tr");
        const statusClass = row.status === "ok" ? "status-ok" : row.status === "warn" ? "status-warn" : "status-err";
        tr.innerHTML = `
          <td>${sourceName[row.source] || row.source}</td>
          <td>${categoryName[row.category] || row.category}</td>
          <td class="${statusClass}">${(row.status || "--").toUpperCase()}</td>
          <td style="font-family:var(--font-mono);font-size:0.78rem;">${row.last_success_timestamp || "No successful run"}</td>
          <td style="font-family:var(--font-mono);font-size:0.78rem;">${row.last_observation_period || "--"}</td>
          <td style="font-family:var(--font-mono);">${row.run_age_hours ?? "--"}</td>
          <td style="color:var(--text-secondary);font-size:0.82rem;">${row.detail || "--"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function formatCountdown(seconds) {
      if (seconds === null || seconds === undefined) return "--";
      const s = Math.max(0, Number(seconds));
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      return `${d}d ${h}h ${m}m`;
    }

    function renderReleaseIntel(latest, upcomingRelease, consensus, forecast, liveDays) {
      const grid = document.getElementById("release-grid");
      const official = latest.official_cpi || {};
      const officialYoy = official.yoy_display_pct ?? official.yoy_pct;
      const consensusYoy = consensus?.headline_yoy ?? latest.headline?.consensus_yoy;
      const consensusMom = consensus?.headline_mom ?? null;
      const deviation = latest.headline?.deviation_yoy_pct ?? latest.headline?.consensus_spread_yoy;
      const deviationEnabled = liveDays >= 30 && consensusYoy !== null && consensusYoy !== undefined;
      const nextRelease = upcomingRelease?.next_release || latest.meta?.release_intelligence || {};
      const nextForecast = forecast || latest.meta?.forecast || {};
      const cards = [
        {
          title: "Next CPI Release (ET)",
          value: nextRelease.release_at_et || "--",
          note: "StatCan calendar",
        },
        {
          title: "Countdown",
          value: formatCountdown(nextRelease.countdown_seconds),
          note: "Until next publication",
        },
        {
          title: "Consensus YoY",
          value: consensusYoy === null || consensusYoy === undefined ? "Unavailable" : `${Number(consensusYoy).toFixed(2)}%`,
          note: consensusYoy === null || consensusYoy === undefined
            ? "Not yet available"
            : "Free-source estimate",
        },
        {
          title: "Consensus MoM",
          value: consensusMom === null || consensusMom === undefined ? "--" : `${Number(consensusMom).toFixed(2)}%`,
          note: "Free-source estimate",
        },
        {
          title: "Last Actual CPI",
          value: `${pct(officialYoy, 1)} YoY / ${pct(official.mom_pct)} MoM`,
          note: `Release: ${official.latest_release_month || "--"}`,
        },
        {
          title: "Deviation",
          value: !deviationEnabled || deviation === null || deviation === undefined
            ? "Unavailable"
            : `${Number(deviation).toFixed(2)} pp`,
          note: consensusYoy === null || consensusYoy === undefined
            ? "Consensus unavailable"
            : liveDays < 30
              ? "Needs 30 live days"
              : "Nowcast YoY ‚àí consensus YoY",
        },
        {
          title: "Forecast: Next YoY",
          value: nextForecast.status === "published" && nextForecast.point_yoy !== null && nextForecast.point_yoy !== undefined
            ? `${Number(nextForecast.point_yoy).toFixed(2)}%`
            : "Withheld",
          note: nextForecast.status === "published"
            ? `Range ${pct(nextForecast.lower_yoy, 2)} ‚Äì ${pct(nextForecast.upper_yoy, 2)} | ${String(nextForecast.confidence || "low").toUpperCase()}`
            : "Need more live history",
        },
      ];
      grid.innerHTML = "";
      cards.forEach((card) => {
        const el = document.createElement("article");
        el.className = "intel-chip";
        el.title = card.note;
        el.innerHTML = `
          <div class="eyebrow">${card.title}</div>
          <div class="chip-value">${card.value}</div>
          <div class="chip-note">${card.note}</div>
        `;
        grid.appendChild(el);
      });
    }

    function renderHero(latest) {
      const yoy = latest.official_cpi?.yoy_pct;
      const yoyDisplay = latest.official_cpi?.yoy_display_pct;
      const nowcast = latest.headline?.nowcast_yoy_pct;
      const consensus = latest.headline?.consensus_yoy;
      const deviation = (nowcast !== null && nowcast !== undefined && consensus !== null && consensus !== undefined)
        ? Number((nowcast - consensus).toFixed(3))
        : null;

      const hero = document.getElementById("hero-yoy");
      hero.textContent = pct(yoyDisplay !== null && yoyDisplay !== undefined ? yoyDisplay : yoy, 1);
      hero.className = `hero-number ${toneClass(yoy)}`;

      let summary = "Official CPI is unavailable right now.";
      if (yoy !== null && yoy !== undefined) {
        if (yoy < 2) summary = "Prices are rising slowly compared with last year. Day-to-day budget pressure is lighter.";
        else if (yoy <= 4) summary = "Prices are rising at a moderate pace. Many households still feel pressure on essentials.";
        else summary = "Prices are rising quickly. Most households are likely feeling broad budget strain.";
      }
      document.getElementById("hero-summary").textContent = summary;
      document.getElementById("hero-summary").classList.remove("loading");
      document.getElementById("hero-nowcast").textContent = pct(nowcast, 3);
      document.getElementById("hero-divergence").textContent = `YoY deviation: ${pct(deviation, 3)}`;
      document.getElementById("hero-release").textContent = maybe(latest.official_cpi?.latest_release_month);
      const quality = latest.headline?.signal_quality_score;
      document.getElementById("hero-confidence").textContent = `${(latest.headline?.confidence || "--").toUpperCase()} | ${quality ?? "--"}/100`;
    }

    function renderPurchasingPowerCard(latest) {
      const topDriver = latest.meta?.top_driver || { category: null, contribution_pct: null };
      const yoy = latest.official_cpi?.yoy_pct;
      const purchasingPower = yoy === null || yoy === undefined ? null : (100 / (1 + (Number(yoy) / 100)));
      document.getElementById("card-power-title").textContent = purchasingPower === null
        ? "Purchasing power: unavailable"
        : `$100 buys ~$${purchasingPower.toFixed(2)} of last year's basket`;
      const topText = topDriver.category
        ? `${topDriver.category} is currently the strongest driver (${pct(topDriver.contribution_pct, 3)} weighted impact this month).`
        : "Top category driver will appear once enough daily history accumulates.";
      document.getElementById("card-power-body").textContent = topText;
    }

    function renderNotes(latest) {
      const ul = document.getElementById("notes-list");
      ul.innerHTML = "";
      (latest.notes || []).forEach(note => {
        const li = document.createElement("li");
        li.textContent = note;
        ul.appendChild(li);
      });
    }

    function renderMethodology(methodology, latest) {
      const ul = document.getElementById("methodology-list");
      ul.innerHTML = "";
      const gate = methodology?.gate_policy || {};
      const weightsRef = methodology?.weights_reference || latest.meta?.weights || {};
      const trackedShare = weightsRef.tracked_share_total;
      const repThreshold = gate.representativeness_min_fresh_ratio;
      const topDriver = latest.meta?.top_driver || {};
      const rows = [
        `Method version: ${latest.meta?.method_version || methodology?.method_version || "--"}`,
        `Coverage ratio: ${(100 * (latest.headline?.coverage_ratio || 0)).toFixed(1)}% of basket had usable data today.`,
        `Tracked basket share: ${typeof trackedShare === "number" ? (100 * trackedShare).toFixed(1) : "--"}% (source: ${weightsRef.source_table || "StatCan"}).`,
        `Lead signal: ${(latest.headline?.lead_signal || "--").toUpperCase()} ‚Äî prices moving ${latest.headline?.lead_signal || "--"}.`,
        `Top driver: ${topDriver.category || "--"} (${pct(topDriver.contribution_pct, 3)} contribution).`,
        `Food gate: ‚â•${gate.food_gate?.min_fresh_sources ?? "--"} fresh / ${gate.food_gate?.min_usable_sources ?? "--"} usable sources.`,
        `Representativeness threshold: ${typeof repThreshold === "number" ? (100 * repThreshold).toFixed(0) : "--"}% fresh basket coverage.`,
        "Housing blends live asking-rent momentum with broader proxies; differs from survey-based CPI.",
        "Communication is mapped within broader CPI structures, not a standalone major component.",
      ];
      rows.forEach(text => {
        const li = document.createElement("li");
        li.textContent = text;
        ul.appendChild(li);
      });
    }

    function applyReleaseBanner(latest) {
      const release = latest.release || {};
      const banner = document.getElementById("release-banner");
      banner.style.display = "block";
      if (release.status && release.status !== "published") {
        banner.textContent = `Release status: ${release.status}. ${(release.blocked_conditions || []).join(" | ")}`;
        return;
      }
      banner.textContent = `Release status: published. Calculation ID: ${release.run_id || "--"}.`;
    }

    function renderPerformance(performance, liveDays) {
      const ul = document.getElementById("performance-list");
      ul.innerHTML = "";
      const rows = [
        `Evaluation window: last ${performance?.window_days ?? "--"} days`,
        `Evaluated points (raw): ${performance?.evaluated_points ?? "--"}`,
        `Evaluated live points (non-seeded): ${performance?.evaluated_live_points ?? "--"}`,
        `Live nowcast days accumulated: ${liveDays}`,
        `MAE (YoY): ${performance?.mae_yoy_pct ?? "--"} pp`,
        `Median abs error (YoY): ${performance?.median_abs_error_yoy_pct ?? "--"} pp`,
        `Directional accuracy (YoY): ${performance?.directional_accuracy_yoy_pct ?? "--"}%`,
        `Bias (YoY): ${performance?.bias_yoy_pct ?? "--"} pp`,
        `MAE (MoM): ${performance?.mae_mom_pct ?? "--"} pp`,
        `Directional accuracy (MoM): ${performance?.directional_accuracy_pct ?? "--"}%`,
        "Interpret all metrics cautiously until 30‚Äì60 live days accumulate.",
      ];
      rows.forEach(text => {
        const li = document.createElement("li");
        li.textContent = text;
        ul.appendChild(li);
      });
    }

    function renderCalibration(calibration) {
      const ul = document.getElementById("calibration-list");
      ul.innerHTML = "";
      const current = calibration || {};
      const metrics = current.current_error_metrics || {};
      const eligibility = current.forecast_eligibility || {};
      const rows = [
        `Maturity tier: ${(current.maturity_tier || "--").toUpperCase()}`,
        `Live days: ${current.live_days ?? "--"} (stable-eval target: ${current.minimum_days_for_stable_eval ?? "--"} days)`,
        `Forecast eligibility: ${eligibility.eligible ? "ELIGIBLE" : "NOT ELIGIBLE"}${eligibility.reason ? ` (${eligibility.reason})` : ""}`,
        `YoY MAE: ${metrics.mae_yoy_pct ?? "--"} pp`,
        `YoY median abs error: ${metrics.median_abs_error_yoy_pct ?? "--"} pp`,
        `YoY directional accuracy: ${metrics.directional_accuracy_yoy_pct ?? "--"}%`,
        `YoY bias: ${metrics.bias_yoy_pct ?? "--"} pp`,
        "Calibration applies moderate shrinkage toward official trend when source diversity is weak.",
      ];
      rows.forEach((text) => {
        const li = document.createElement("li");
        li.textContent = text;
        ul.appendChild(li);
      });
    }

    function renderExplainers() {
      const grid = document.getElementById("explain-grid");
      grid.innerHTML = "";
      const rows = [
        "Official CPI (YoY): year-over-year inflation from Statistics Canada.",
        "Nowcast Signal: model-implied annual inflation from live public data signals.",
        "Deviation: nowcast YoY minus available consensus YoY.",
        "Data quality score reflects source coverage, recency, anomaly filtering, and diversity.",
        "Live nowcast began Feb 16 2026 by design for authenticity.",
      ];
      rows.forEach((text) => {
        const el = document.createElement("div");
        el.className = "explainer-item";
        el.textContent = text;
        grid.appendChild(el);
      });
    }

    function renderPulse(meta) {
      const indicators = meta.indicators || {};
      const rent = indicators.average_asking_rent;
      const gas = indicators.gasoline_canada_avg;
      const section = document.getElementById("pulse-section");
      if (rent || gas) section.style.display = "block";
      if (rent) document.getElementById("pulse-rent").textContent = "$" + Math.round(rent).toLocaleString();
      if (gas) document.getElementById("pulse-gas").textContent = gas.toFixed(1) + " ¬¢/L";
    }

    async function fetchCommunityStats() {
      try {
        const res = await fetch('/v1/community/stats');
        if (!res.ok) return;
        const stats = await res.json();
        if (stats.length === 0) return;
        const section = document.getElementByI'co-section');
        const grid = document.getElementById('community-stats-grid');
        section.style.display = 'block';
        grid.innerHTML = '';
        stats.forEach(s => {
          const card = document.createElement('div');
          card.className = 'intel-chip';
          let icon = '', unit = '';
          if (s.category === 'gas') { icon = '‚õΩ'; unit = '¬¢/L'; }
          else if (s.category === 'rent') { icon = 'üè†'; unit = '$/mo'; }
          else { icon = 'üõí'; unit = '$'; }
          card.innerHTML = `
            <div class="eyebrow">${icon} Community ${s.category.toUpperCase()}</div>
            <div class="chip-value" style="color:var(--blue);">${s.avg_price} ${unit}</div>
            <div class="chip-note">Based on ${s.count} report(s)</div>
          `;
          grid.appendChild(card);
        });
      } catch (e) {
        console.error("Failed to fetch community stats:", e);
      }
    }

    if (!UI_MODE_V2) {
      document.getElementById("app").innerHTML = "<section class='card'><h2 style='margin-bottom:.5rem;'>UI v2 is disabled</h2><p style='color:var(--text-secondary);'>Append <code>?ui_v2=1</code> to enable the dashboard.</p></section>";
    } else {
      renderExplainers();
      fetchCommunityStats();
      Promise.all([
        fetchLatestSnapshot(),
        fetchJsonWithFallback("/v1/nowcast/history", "data/historical.json"),
        fetchJsonWithFallback("/v1/methodology", "data/published_latest.json"),
        fetchJsonWithFallback("/v1/performance/summary", "data/performance_summary.json"),
        fetchJsonWithFallback("/v1/releases/upcoming", "data/release_events.json"),
        fetchJsonWithFallback("/v1/consensus/latest", "data/consensus_latest.json"),
        fetchJsonWithFallback("/v1/forecast/next_release", "data/latest.json"),
        fetchJsonWithFallback("/v1/calibration/status", "data/latest.json"),
      ]).then(([latest, historical, methodology, performance, upcomingRelease, consensus, forecast, calibration]) => {
        document.getElementById("asof").textContent = `as of ${latest.as_of_date || "--"}`;
        const items = safeHistoryItems(historical).slice(-365);
        const liveDays = countLiveNowcastDays(items);
        applyReleaseBanner(latest);
        renderHero(latest);
        renderPulse(latest.meta || {});
        renderReleaseIntel(latest, upcomingRelease, consensus, forecast?.meta?.forecast || forecast, liveDays);
        renderPurchasingPowerCard(latest);
        renderNotes(latest);
        renderSourceTable(latest.source_health || []);
        renderMethodology(methodology, latest);
        renderPerformance(performance, liveDays);
        renderCalibration(calibration?.meta?.calibration || calibration || latest.meta?.calibration || {});
        renderDivergence(items.slice(-90));
        renderCategoryChart(latest);
      }).catch(err => {
        document.body.innerHTML = `<main class='page'><section class='card'><h2 style='margin-bottom:.5rem;'>Data load error</h2><p style='color:var(--text-secondary);'>${String(err)}</p></section></main>`;
      });
    }
  </script>
</body>

</html>